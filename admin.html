<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyCraft | Admin Manager</title>
    
    <script src="admin-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #6366f1; --dark: #0f172a; --bg: #f1f5f9; --success: #10b981; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--dark); padding: 40px; }

        #loginOverlay { position: fixed; inset: 0; background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-card { background: white; padding: 3rem; border-radius: 35px; width: 400px; text-align: center; }
        input[type="password"] { width: 100%; padding: 1.2rem; margin-bottom: 1.2rem; border-radius: 15px; border: 2px solid #e2e8f0; font-size: 1.1rem; }
        
        .main-container { display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

        .table-wrapper { background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; padding: 20px; text-align: left; font-size: 0.8rem; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #edf2f7; }
        td { padding: 20px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }

        .promo-tag { background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; }
        .download-btn { padding: 8px 14px; background: #f1f5f9; color: var(--primary); text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 0.8rem; border: 1px solid #e2e8f0; }
        
        /* Completed Row Style */
        tr.completed-row { opacity: 0.6; background: #f8fafc; }
        .status-btn { background: var(--success); color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card">
            <h2>Admin Access</h2>
            <input type="password" id="adminPass" placeholder="Enter Password">
            <button onclick="handleLogin()" style="width:100%; padding:1rem; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:800; cursor:pointer;">Unlock</button>
        </div>
    </div>

    <div class="main-container" id="adminUI">
        <div class="header">
            <h1>Order History</h1>
            <button onclick="location.reload()" style="padding:10px 20px; border-radius:10px; border:1px solid #ccc; cursor:pointer;">Lock Panel</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Promo/Discount</th>
                        <th>Final Price</th>
                        <th>Photos</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="orderTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const sb = supabase.createClient(CONFIG.SB_URL, CONFIG.SB_KEY);

        function simpleHash(str) {
            let h = 0; for (let i = 0; i < str.length; i++) { h = (h << 5) - h + str.charCodeAt(i); h |= 0; }
            return h.toString();
        }

        function handleLogin() {
            const typed = document.getElementById('adminPass').value;
            if (simpleHash(typed) === CONFIG.ADMIN_PASSWORD_HASH) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminUI').style.display = 'block';
                loadOrders();
            } else { alert("Incorrect Password"); }
        }

        async function loadOrders() {
            const { data: orders, error } = await sb.from('orders').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);

            const table = document.getElementById('orderTable');
            table.innerHTML = "";

            orders.forEach(order => {
                const isDone = order.is_completed; // Assumes you have 'is_completed' column (boolean)
                const fUrl = sb.storage.from('order-photos').getPublicUrl(order.front_photo_path).data.publicUrl;
                const bUrl = sb.storage.from('order-photos').getPublicUrl(order.back_photo_path).data.publicUrl;

                table.innerHTML += `
                    <tr class="${isDone ? 'completed-row' : ''}">
                        <td>
                            <input type="checkbox" ${isDone ? 'checked' : ''} 
                                   onchange="toggleComplete(${order.id}, this.checked)" 
                                   style="width:20px; height:20px; cursor:pointer;">
                        </td>
                        <td style="font-size:0.8rem; color:#94a3b8;">#${order.id}</td>
                        <td>
                            <strong>${order.customer_name}</strong><br>
                            <span style="font-size:0.8rem; color:#64748b;">${order.phone}</span>
                        </td>
                        <td>
                            ${order.promo_code ? `<span class="promo-tag">${order.promo_code}</span>` : '<span style="color:#cbd5e1">â€”</span>'}
                        </td>
                        <td style="font-weight:800; color:#059669;">${order.total_price_aed} AED</td>
                        <td>
                            <a href="${fUrl}" target="_blank" class="download-btn">Front</a>
                            <a href="${bUrl}" target="_blank" class="download-btn">Back</a>
                        </td>
                        <td style="font-size:0.8rem;">${new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });
        }

        async function toggleComplete(orderId, status) {
            const { error } = await sb.from('orders')
                .update({ is_completed: status })
                .eq('id', orderId);
            
            if (error) {
                alert("Error updating status");
            } else {
                loadOrders(); // Refresh list to show fade effect
            }
        }
    </script>
</body>
</html>
