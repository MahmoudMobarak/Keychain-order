<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyCraft - Custom Keychains | 4 AED</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: #2c3e50; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }

        /* Animations */
        .animate, .animate-item { opacity: 0; transform: translateY(40px); }
        .animate.show, .animate-item.show { opacity: 1; transform: translateY(0); transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        /* Navbar */
        .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 1rem 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #2c3e50, #34495e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-links { display: flex; gap: 2rem; }
        .nav-link { color: #7f8c8d; text-decoration: none; font-weight: 500; position: relative; }
        .nav-link:hover { color: #2c3e50; }

        /* Hero */
        .hero-section { min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; padding: 140px 0 80px; color: white; }
        .hero-content { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; }
        .hero-text h1 { font-size: clamp(3rem, 8vw, 5rem); font-weight: 800; line-height: 1.1; margin-bottom: 1.5rem; }
        .hero-price { font-size: clamp(4rem, 10vw, 6rem); font-weight: 900; background: linear-gradient(45deg, #f39c12, #e67e22); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
        .hero-badges { list-style: none; display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 1.5rem 0 3rem 0; }
        .hero-badges li { background: rgba(0,0,0,0.2); border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.9rem; }
        .hero-cta { display: inline-block; background: rgba(255,255,255,0.95); color: #2c3e50; padding: 1.5rem 3rem; border-radius: 50px; font-size: 1.2rem; font-weight: 700; text-decoration: none; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .hero-cta:hover { transform: translateY(-5px); box-shadow: 0 30px 60px rgba(0,0,0,0.4); }

        /* Benefits */
        .benefits-section { padding: 100px 0; background: #f8f9fa; }
        .benefits-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .benefit-item { background: white; padding: 2.5rem; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .benefit-item h3 { font-size: 1.5rem; margin-bottom: 1rem; color: #2c3e50; }

        /* Order Form */
        .order-section { padding: 120px 0 160px; }
        .section-title { text-align: center; font-size: clamp(2.5rem, 5vw, 4rem); font-weight: 700; margin-bottom: 4rem; }
        .order-form { max-width: 1000px; margin: 0 auto; background: white; padding: 4rem; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); }
        
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .input-group label { font-weight: 600; margin-bottom: 0.75rem; display: block; }
        .input-group input { width: 100%; padding: 1.25rem 1.5rem; border: 2px solid #ecf0f1; border-radius: 16px; font-size: 1rem; }
        .input-group input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 4px rgba(52,152,219,0.1); }

        /* Quantity */
        .quantity-section { text-align: center; margin: 2rem 0; }
        .quantity-buttons { display: flex; align-items: center; justify-content: center; gap: 1.5rem; margin-top: 1rem; }
        .qty-btn { width: 56px; height: 56px; border: 2px solid #bdc3c7; background: white; border-radius: 16px; font-size: 1.8rem; font-weight: 700; cursor: pointer; }
        .qty-btn:hover { background: #3498db; color: white; border-color: #3498db; transform: scale(1.05); }
        #quantity { width: 80px; height: 56px; border: 2px solid #bdc3c7; border-radius: 16px; text-align: center; font-size: 1.8rem; font-weight: 700; }

        /* Photo Upload */
        .photo-section { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; margin: 4rem 0; }
        .photo-upload-area { height: 320px; position: relative; border: 3px dashed #bdc3c7; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; cursor: pointer; overflow: hidden; }
        .photo-upload-area:hover { border-color: #3498db; background: #eaf3ff; }
        .photo-upload-area.uploaded { border-color: #27ae60; background: #eafaf1; }
        .upload-icon { font-size: 4rem; margin-bottom: 1rem; }
        .photo-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-upload-area.uploaded .photo-preview { display: block; }
        .upload-status { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); background: rgba(39,174,96,0.9); color: white; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 600; display: none; z-index: 20; }
        .photo-upload-area.uploaded .upload-status { display: block; }

        /* Pricing & Button */
        .pricing-section { background: #f8f9fa; padding: 2.5rem; border-radius: 20px; margin: 3rem 0; }
        .price-row { display: flex; justify-content: space-between; padding: 1.25rem 0; font-size: 1.1rem; }
        .price-row.total { border-top: 3px solid #3498db; font-size: 1.5rem; font-weight: 800; padding: 2rem 0 1.25rem 0 !important; }
        .order-btn { width: 100%; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; padding: 1.75rem; border-radius: 20px; font-size: 1.4rem; font-weight: 700; cursor: pointer; box-shadow: 0 15px 35px rgba(52,152,219,0.3); }
        .order-btn:hover:not(:disabled) { transform: translateY(-5px); box-shadow: 0 25px 50px rgba(52,152,219,0.4); }
        .order-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .loader { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-left: 10px; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Receipt Modal */
        .receipt-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; padding: 2rem; }
        .receipt-card { background: white; border-radius: 28px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 30px 80px rgba(0,0,0,0.4); }
        .receipt-top { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 3rem 2.5rem 2rem; text-align: center; border-radius: 28px 28px 0 0; }
        .receipt-content { padding: 3rem 2.5rem; }
        .info-line, .order-item { display: flex; justify-content: space-between; padding: 1rem 0; border-bottom: 1px solid #ecf0f1; }
        .order-total { border-top: 3px solid #3498db; padding-top: 1.5rem !important; font-size: 1.4rem; font-weight: 800; display: flex; justify-content: space-between; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem; }
        .photo-cell img { width: 100%; border-radius: 12px; border: 1px solid #ddd; }
        .receipt-actions { padding: 2.5rem; display: flex; gap: 1.5rem; border-top: 1px solid #ecf0f1; }
        .pdf-btn, .close-btn { flex: 1; padding: 1.25rem; border-radius: 16px; font-weight: 700; cursor: pointer; border: none; }
        .pdf-btn { background: #27ae60; color: white; }
        .close-btn { background: #ecf0f1; color: #2c3e50; }

        @media (max-width: 768px) {
            .input-row, .photo-section, .hero-content { grid-template-columns: 1fr; }
            .order-form { padding: 2rem 1.5rem; }
        }
    </style>
</head>
<body>
    
    <nav class="navbar animate">
        <div class="nav-container">
            <div class="logo">KeyCraft</div>
            <div class="nav-links">
                <a href="#hero" class="nav-link active">Product</a>
                <a href="#order" class="nav-link">Order</a>
            </div>
        </div>
    </nav>

    <section id="hero" class="hero-section animate">
        <div class="hero-content">
            <div class="hero-text animate-item">
                <h1>Custom Photo Keychains</h1>
                <div class="hero-price">4<span>AED</span></div>
                <p>Turn your favourite photos into everyday mini-memories. Perfect for school bags & gifts.</p>
                <ul class="hero-badges">
                    <li>âœ… 24hr Production</li>
                    <li>âœ… Double-Sided</li>
                    <li>âœ… Premium Quality</li>
                </ul>
                <a href="#order" class="hero-cta">Order Now</a>
            </div>
        </div>
    </section>

    <section class="benefits-section animate">
        <div class="container">
            <div class="benefits-grid">
                <div class="benefit-item"><h3>ðŸŽ¯ Personal Gifts</h3><p>Upload front & back photos in seconds.</p></div>
                <div class="benefit-item"><h3>ðŸ’° Student Friendly</h3><p>Affordable luxury at just 4 AED.</p></div>
                <div class="benefit-item"><h3>âš¡ Fast Delivery</h3><p>Ready for collection within 24 hours.</p></div>
            </div>
        </div>
    </section>

    <section id="order" class="order-section animate">
        <div class="container">
            <h2 class="section-title animate-item">Place Your Order</h2>
            <form id="orderForm" class="order-form animate-item">
                <div class="input-row">
                    <div class="input-group">
                        <label>Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="input-group">
                        <label>Email *</label>
                        <input type="email" id="customerEmail" required>
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="input-group">
                        <label>Promo Code</label>
                        <input type="text" id="promoCode" placeholder="Enter code...">
                        <small id="promoStatus" style="display:none; margin-top:5px; font-weight:600;"></small>
                    </div>
                </div>

                <div class="quantity-section">
                    <label>Quantity</label>
                    <div class="quantity-buttons">
                        <button type="button" class="qty-btn" id="qtyMinus">-</button>
                        <input type="number" id="quantity" value="1" min="1" max="20" readonly>
                        <button type="button" class="qty-btn" id="qtyPlus">+</button>
                    </div>
                </div>

                <div class="photo-section">
                    <div class="photo-upload-area" id="frontUpload">
                        <input type="file" id="frontPhoto" accept="image/*" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10;">
                        <div class="upload-icon">ðŸ“·</div>
                        <h3>FRONT PHOTO</h3>
                        <img id="frontPreview" class="photo-preview">
                        <div class="upload-status" id="frontStatus"></div>
                    </div>
                    <div class="photo-upload-area" id="backUpload">
                        <input type="file" id="backPhoto" accept="image/*" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10;">
                        <div class="upload-icon">ðŸ“·</div>
                        <h3>BACK PHOTO</h3>
                        <img id="backPreview" class="photo-preview">
                        <div class="upload-status" id="backStatus"></div>
                    </div>
                </div>

                <div class="pricing-section">
                    <div class="price-row">
                        <span>Subtotal (<span id="qtyDisplay">1</span> Ã— 4 AED)</span>
                        <span id="subtotal">4.00 AED</span>
                    </div>
                    <div class="price-row discount" id="discountRow" style="display: none; color: #e74c3c;">
                        <span>Discount</span>
                        <span id="discount">0.00 AED</span>
                    </div>
                    <div class="price-row total">
                        <span>TOTAL</span>
                        <span id="total">4.00 AED</span>
                    </div>
                </div>

                <button type="submit" class="order-btn" id="submitBtn">
                    <span>Place Order</span>
                    <div class="loader"></div>
                </button>
            </form>
        </div>
    </section>

    <div id="receiptModal" class="receipt-modal">
        <div class="receipt-card">
            <div class="receipt-top">
                <h1>KeyCraft</h1>
                <div id="orderId" style="opacity:0.8; margin-top:5px;">#</div>
            </div>
            <div class="receipt-content">
                <div class="info-line"><span>Name:</span><span id="receiptCustomer"></span></div>
                <div class="info-line"><span>Email:</span><span id="receiptEmail"></span></div>
                <div class="order-item">
                    <div>Custom Keychains Ã— <span id="receiptQty">1</span></div>
                    <div id="receiptSubtotal">4.00 AED</div>
                </div>
                <div class="order-item" id="receiptDiscountRow" style="display: none; color:#e74c3c;">
                    <div>Discount</div>
                    <div id="receiptDiscount">0.00 AED</div>
                </div>
                <div class="order-total">
                    <div>TOTAL</div>
                    <div id="receiptTotal">4.00 AED</div>
                </div>
                <div class="photo-grid">
                    <div class="photo-cell"><img id="receiptFront"></div>
                    <div class="photo-cell"><img id="receiptBack"></div>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="pdf-btn" onclick="downloadPDF()">ðŸ“„ Download PDF</button>
                <button class="close-btn" onclick="closeModal()">New Order</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = "https://pkzvftleoysldqmjdgds.supabase.co";
        const SUPABASE_KEY = "sb_publishable_H9QIgdBqQZtHXcywZyDsjA_s4fXffjN"; // Insert your key if different
        const EMAILJS_KEY = "wFE7Ll5cDKSxM4Zfs";
        const EMAILJS_SERVICE = "service_zlh57wd";
        const EMAILJS_TEMPLATE_CUSTOMER = "template_hu5h00o";
        const EMAILJS_TEMPLATE_ADMIN = "template_i0rlm7u";

        let supabase, activePromoCodes = [];
        let frontPhotoFile = null, backPhotoFile = null;

        // INITIALIZATION
        window.addEventListener('load', async () => {
            document.body.classList.add('loaded');
            
            // Init Libraries
            emailjs.init(EMAILJS_KEY);
            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

            // Fetch Active Promo Codes from DB
            fetchPromoCodes();

            // Scroll Animation
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('show');
                        observer.unobserve(entry.target);
                    }
                });
            });
            document.querySelectorAll('.animate, .animate-item').forEach(el => observer.observe(el));
        });

        // 1. FETCH PROMO CODES
        async function fetchPromoCodes() {
            try {
                const { data, error } = await supabase.from('promo_codes').select('*').eq('active', true);
                if (!error) activePromoCodes = data;
            } catch (err) { console.error("Error loading promos", err); }
        }

        // 2. UI INTERACTION
        document.getElementById('qtyMinus').onclick = () => updateQty(-1);
        document.getElementById('qtyPlus').onclick = () => updateQty(1);
        document.getElementById('promoCode').addEventListener('input', updatePricing);
        
        setupPhotoUpload('frontUpload', 'frontPhoto', 'frontPreview', 'frontStatus', f => frontPhotoFile = f);
        setupPhotoUpload('backUpload', 'backPhoto', 'backPreview', 'backStatus', f => backPhotoFile = f);

        function updateQty(change) {
            const el = document.getElementById('quantity');
            let val = parseInt(el.value) + change;
            if (val >= 1 && val <= 20) {
                el.value = val;
                document.getElementById('qtyDisplay').textContent = val;
                updatePricing();
            }
        }

        function setupPhotoUpload(divId, inputId, imgId, statusId, callback) {
            document.getElementById(inputId).onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        document.getElementById(imgId).src = ev.target.result;
                        document.getElementById(divId).classList.add('uploaded');
                        document.getElementById(statusId).textContent = 'âœ… Uploaded';
                        callback(file);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        // 3. PRICING LOGIC
        function updatePricing() {
            const qty = parseInt(document.getElementById('quantity').value);
            const subtotal = qty * 4;
            const userCode = document.getElementById('promoCode').value.trim();
            
            let discount = 0;
            const promo = activePromoCodes.find(p => p.code === userCode); // Match against DB codes

            const statusEl = document.getElementById('promoStatus');
            
            if (userCode && promo) {
                if (promo.discount_type === 'percent') {
                    discount = subtotal * (promo.discount_value / 100);
                } else if (promo.discount_type === 'fixed') {
                    discount = promo.discount_value;
                }
                statusEl.textContent = "Code Applied!";
                statusEl.style.color = "green";
                statusEl.style.display = "block";
            } else if (userCode) {
                statusEl.textContent = "Invalid Code";
                statusEl.style.color = "red";
                statusEl.style.display = "block";
            } else {
                statusEl.style.display = "none";
            }

            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' AED';
            
            if (discount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('discount').textContent = '-' + discount.toFixed(2) + ' AED';
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }
            
            document.getElementById('total').textContent = (subtotal - discount).toFixed(2) + ' AED';
            return { subtotal, discount, total: subtotal - discount, promoCode: promo ? promo.code : null };
        }

        // 4. ORDER SUBMISSION
        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            
            if (!frontPhotoFile || !backPhotoFile) {
                alert("Please upload both front and back photos.");
                return;
            }

            const btn = document.getElementById('submitBtn');
            const loader = btn.querySelector('.loader');
            btn.disabled = true;
            loader.style.display = 'inline-block';
            btn.querySelector('span').textContent = "Processing...";

            try {
                const pricing = updatePricing();
                const formData = {
                    name: document.getElementById('customerName').value,
                    email: document.getElementById('customerEmail').value,
                    phone: document.getElementById('phone').value,
                    qty: parseInt(document.getElementById('quantity').value)
                };

                // A. Upload Photos
                const timestamp = Date.now();
                const frontPath = `order_${timestamp}_front.jpg`;
                const backPath = `order_${timestamp}_back.jpg`;

                await supabase.storage.from('order-photos').upload(frontPath, frontPhotoFile);
                await supabase.storage.from('order-photos').upload(backPath, backPhotoFile);

                const frontUrl = supabase.storage.from('order-photos').getPublicUrl(frontPath).data.publicUrl;
                const backUrl = supabase.storage.from('order-photos').getPublicUrl(backPath).data.publicUrl;

                // B. Insert to Database (Using Items JSONB)
                const { data: order, error } = await supabase.from('orders').insert([{
                    customer_name: formData.name,
                    customer_email: formData.email,
                    phone: formData.phone,
                    items: { quantity: formData.qty, unit_price: 4 }, // JSONB Structure
                    promo_code: pricing.promoCode,
                    discount_amount: pricing.discount,
                    total_price_aed: pricing.total,
                    front_photo_path: frontPath,
                    back_photo_path: backPath
                }]).select().single();

                if (error) throw error;

                // C. Send Emails
                const emailParams = {
                    order_id: order.id,
                    customer_name: formData.name,
                    customer_email: formData.email,
                    quantity: formData.qty,
                    total_price: pricing.total.toFixed(2),
                    front_url: frontUrl,
                    back_url: backUrl
                };

                await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE_CUSTOMER, emailParams);
                await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE_ADMIN, emailParams);

                // D. Show Receipt
                showReceipt(order.id, formData, pricing);

            } catch (err) {
                console.error(err);
                alert("Order failed. Please try again.");
                btn.disabled = false;
                loader.style.display = 'none';
                btn.querySelector('span').textContent = "Place Order";
            }
        };

        // 5. RECEIPT & PDF
        function showReceipt(id, data, pricing) {
            document.getElementById('orderId').textContent = '#' + id;
            document.getElementById('receiptCustomer').textContent = data.name;
            document.getElementById('receiptEmail').textContent = data.email;
            document.getElementById('receiptQty').textContent = data.qty;
            document.getElementById('receiptSubtotal').textContent = pricing.subtotal.toFixed(2) + ' AED';
            
            if (pricing.discount > 0) {
                document.getElementById('receiptDiscountRow').style.display = 'flex';
                document.getElementById('receiptDiscount').textContent = '-' + pricing.discount.toFixed(2) + ' AED';
            }
            
            document.getElementById('receiptTotal').textContent = pricing.total.toFixed(2) + ' AED';
            document.getElementById('receiptFront').src = document.getElementById('frontPreview').src;
            document.getElementById('receiptBack').src = document.getElementById('backPreview').src;
            
            document.getElementById('receiptModal').style.display = 'flex';
            
            // Reset Button State (hidden behind modal anyway)
            const btn = document.getElementById('submitBtn');
            btn.disabled = false;
            btn.querySelector('.loader').style.display = 'none';
            btn.querySelector('span').textContent = "Place Order";
        }

        function downloadPDF() {
            const el = document.querySelector('.receipt-card');
            const btns = document.querySelector('.receipt-actions');
            btns.style.display = 'none'; // Hide buttons for screenshot
            
            html2canvas(el, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const width = 190;
                const height = (canvas.height * width) / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 10, width, height);
                pdf.save(`KeyCraft_Receipt.pdf`);
                btns.style.display = 'flex'; // Show buttons again
            });
        }

        function closeModal() {
            location.reload(); // Simple reload to clear form and start fresh
        }
    </script>
</body>
</html>
